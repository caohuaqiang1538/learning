<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
   	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
   <title></title>
    <script src="../js/mui.min.js"></script>
    <link href="../css/mui.min.css" rel="stylesheet"/>
    <link href="../css/main.css" rel="stylesheet"/>
    <link href="../font/iconfont.css" rel="stylesheet"/>
    <script type="text/javascript" src="../js/mui.min.js"></script>
    <style>
    	html,body{
    		height:100%;
    		background: #fff;
    	}
    	#MY{
    		height: 100%;
    		overflow: scroll;
    	}
    	.mui-bar-nav{
    		box-shadow: none;
    		background: #fff;
    	}
    	.mui-content>.mui-table-view{
    		margin-top: 15px;
    	}
    	.mui-table-view-cell{
    		padding: 15px 15px;
    	}
    	.spanMargin{
    		margin-right: 20px;
    	}
    	.my-photo{
    		width: 100px;
    		height: 100px;
    		border-radius: 50%;
    		border: 1px solid #0099ff;
    	}
    	.my-photoBox{
    		height: auto;
		    display: table;
		    position: relative;
		    margin: 0 auto;
    	}
    	.my-photoBox>span{
    		position: absolute;
		    bottom: 5px;
		    right: 5px;
		    color: #0099ff;
    	}
    	.my-photoBox>span>i{
    		font-size: 30px;
    	}
    	#my-photoCont .mui-active{
    		background: #ffffff;
    	}
    	.mui-bar-nav{
    		background: #0099ff;
    	}
    	.mui-title{
    		color: #fff;
    	}
    	.mui-action-back{
    		color: #fff;
    	}
    	.iconfont{
    		font-size: 24px;
    		margin-right: 10px;
    	}
    	#my-show img{
    		width: 95px;
    		height: 95px;
		    border-radius: 6px;
    	}
    	#my-show span{
    		width: calc(100% - 110px);
    		padding-left: 20px;
    	}
    	#my-show span:nth-of-type(1){
    		line-height: 30px;
    		margin-top: 20px;
    		font-size: 20px;
    	}
    	#my-show span:nth-of-type(2){
    		color:#aaaaaa;
    	}
    	#my-show .mui-active{
    		background:#fff;
    	}
    	#my-list img,#my-shop img{
    		width: 25px;
    		vertical-align: middle;
    		margin-right: 10px;
    	}
    	#my-list span,my-shop span{
    		vertical-align: middle;
    		display: inline-block;
    	}
    </style>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
	    <h1 class="mui-title">我</h1>
	</header>
	<div class="mui-content" id="MY">
		<ul class="mui-table-view">
			<li class="mui-table-view-cell" id="my-show" >
				<a href="javascript:;"><img id="my-photo" src="" class="mui-pull-left"><span class="mui-pull-left" id="my-userName"></span><span class="mui-pull-left" id="my-email"></span></a>
			</li>
		</ul>
	    <ul class="mui-table-view" id="my-list">
			<li class="mui-table-view-cell" id="my-message">
				<a href="javascript:;"><img src="../images/mess.png"><span>个人资料</span><span class="mui-pull-right mui-navigate-right"></span></a>
			</li>
			<li class="mui-table-view-cell" id="my-validate">
				<a href="javascript:;"><img src="../images/valde.png"><span>实名认证</span><span class="mui-pull-right mui-navigate-right"></span></a>
			</li>
			<li class="mui-table-view-cell" id="my-changePass">
				<a href="javascript:;"><img src="../images/changePass.png"><span>修改密码</span><span class="mui-pull-right mui-navigate-right"></span></a>
			</li>
			<!--<li class="mui-table-view-cell" id="my-login">
				<a href="javascript:;"><img src="../images/changePass.png"><span>登录</span><span class="mui-pull-right mui-navigate-right"></span></a>
			</li>-->
			<li class="mui-table-view-cell" id="my-about">
				<a href="javascript:;"><img src="../images/about.png"><span>关于我们</span><span class="mui-pull-right mui-navigate-right"></span></a>
			</li>
		</ul>
		
		<ul class="mui-table-view" id="my-shop">
			<li class="mui-table-view-cell" id="my-dealList">
				<a href="javascript:;"><img src="../images/deal.png"><span>我的订单</span><span class="mui-pull-right mui-navigate-right"></span></a>
			</li>
			<li class="mui-table-view-cell" id="my-cars">
				<a href="javascript:;"><img src="../images/cars.png"><span>我的购物车</span><span class="mui-pull-right mui-navigate-right"></span></a>
			</li>
			<li class="mui-table-view-cell" id="my-address">
				<a href="javascript:;"><img src="../images/addrs.png"><span>我的地址</span><span class="mui-pull-right mui-navigate-right"></span></a>
			</li>
		</ul>
	</div>
</body>
<script src="../js/vue.js"></script>
<script src="../js/jquery-2.1.0.js"></script>
<script type="text/javascript">
	mui.init({
      		statusBarBackground: '#0099ff',
     });
	window.addEventListener('refresh', function(e){//执行刷新
	    location.reload();
	});
	mui.plusReady(function() {
		var wt=plus.nativeUI.showWaiting();
		function isEmptyObject(e) {  
		    var t;  
		    for (t in e)  
		        return !1;  
		    return !0  
		}  //判断缓存数据是否为空
		//json格式判断
		function isJSON(str) {
		        if (typeof str == 'string') {
		            try {
		                var obj=JSON.parse(str);
		                if(str.indexOf('{')>-1){
		                    return true;
		                }else{
		                    return false;
		                }
		
		            } catch(e) {
		                return false;
		            }
		        }
		        return false;
		}
		/*判断上次是否退出登录*/
		var URLs = localStorage.getItem("$url");
		var AllUrl = URLs.substring(1,URLs.length-1);
		var state = localStorage.getItem("$state") || {};
		if(isJSON(state)){
			var userID = JSON.parse(state);
		}else{
			var userID = {};
		}
		var message = localStorage.getItem("$userMess") || {};
		if(isJSON(message)){
			var userMess = JSON.parse(message);
		}else{
			var userMess = {}
		}
		var allurlPass = null;
		function checkUser(){
			state = localStorage.getItem("$state") || {};
			if(isJSON(state)){
				userID = JSON.parse(state);
			}else{
				userID ={};
			}
			
			message = localStorage.getItem("$userMess") || {};
			if(isJSON(message)){
				userMess = JSON.parse(message);
			}else{
				userMess = {};
			}
			allurlPass = null;
			if(isEmptyObject(userID)){
				setTimeout(function(){
					wt.close(); 
				},500);
				userMess = {};
				userMess.name = "登录一下，智慧到家";//跳转登录
				userMess.email = "";
				userMess.image = "../images/pic.png";
				allurlPass = "login.html";
				$("#my-userName").text(userMess.name);
				$("#my-email").text(userMess.email);
				$("#my-photo").attr("src",userMess.image);
			}else{
				//var wt=plus.nativeUI.showWaiting();
				//ajax检测账号信息
				$.ajax({
					type:"post",
					url:AllUrl+"/asw-eas/f/UserApp/loginUser",
					async:true,
					data:userID,
					dataType:"jsonp",
					success:function(data){
						if(data.loginBoolean == "false"){
							userMess = {};
							localStorage.setItem("$state","{}");
							localStorage.setItem("$userMess","{}");
							userMess.name = "登录一下，智慧到家";//跳转登录
							allurlPass = "login.html";
							userMess.email = "";
							userMess.image = "../images/pic.png";
							plus.nativeUI.toast("您的密码已修改，请重新登陆");
							$("#my-userName").text(userMess.name);
							$("#my-email").text(userMess.email);
							$("#my-photo").attr("src",userMess.image);
							wt.close(); 
						}else{
							localStorage.setItem("$userMess",JSON.stringify(data.user));//更新个人资料
							userMess = data.user;
							if(data.user.photo == ""){
								userMess.image = "../images/pic.png";
							}else{
								userMess.image = AllUrl+data.user.photo;
							}
							//plus.nativeUI.toast("登录成功");	
							$("#my-userName").text(userMess.name);
							$("#my-email").text(userMess.email);
							$("#my-photo").attr("src",userMess.image);
							wt.close(); 
						}
					},
					error:function(){
						userMess = {};
						localStorage.setItem("$state","{}");
						localStorage.setItem("$userMess","{}");
						userMess.name = "登录一下，智慧到家";//跳转登录
						allurlPass = "login.html";
						plus.nativeUI.toast("服务器暂无响应，请重新登录");
						wt.close(); 
					}
				});
			}
			$("#my-show").on("tap",function(){
				if(userMess.name == '登录一下，智慧到家'){
					mui.openWindow({
						url:"login.html",
						id:"login",
					})
				}else{
					return;
				}
			})
		}
		checkUser();
		$("#my-message").on("tap",function(){
			var messageUrl = allurlPass || "myMessage.html";
			var messageId = allurlPass || "myMessage.html";
			mui.openWindow({
				url:messageUrl,
				id:messageId
			})
		})
		
		//跳转登录
		$("#my-login").on("tap",function(){
			mui.openWindow({
				url:"login.html",
				id:"login",
			})
		})
		//实名认证
		$("#my-validate").on("tap",function(){
			var messageUrl = allurlPass || "validate.html";
			var messageId = allurlPass || "validate.html";
			if(messageUrl == "login.html"){
				mui.openWindow({
					url:messageUrl,
					id:messageId
				})
			}else{
				validatePage()
			}
		})
		function validatePage(){
			$.ajax({
				type:"post",
				url:AllUrl+"/asw-eas/f/realApp/formUserId",
				async:true,
				dataType:"jsonp",
				data:{
					"user.id":userMess.id
				},
				success:function(data){
					var status = data.status;
					if(status == "false"){
						mui.openWindow({
							url:"validate.html",
							id:"validate.html",
							extras:{
							        showTip:false,
							    }
						});
					}else{
						var validateStu = data.realAudit.auditInfo.auditResult;
						if(validateStu == "4"){//认证成功
							mui.openWindow({
								url:"valSuccess.html",
								id:"valSuccess.html",
							});
						}else if(validateStu == "3"){
							var tipCont = data.realAudit.auditInfo.auditCoutent;
							mui.openWindow({
								url:"validate.html",
								id:"validate.html",
								extras:{
							        showTip:true,
							        tip:tipCont,
							        name:data.realAudit.name,
							        bornDate:data.realAudit.bornDate,
							        idType:data.realAudit.idType,
							        idNumber:data.realAudit.idNumber,
							        frontPhoto:data.realAudit.frontPhoto,
							        reversePhoto:data.realAudit.reversePhoto,
							        allId:data.realAudit.id,
							        oneId:data.realAudit.auditInfo.id,
									fkId:data.realAudit.auditInfo.fkId
							    }
							});
						}else if(validateStu == "2"){
							mui.openWindow({
								url:"valLoad.html",
								id:"valLoad.html",
							});
						}
					}
				},
				error:function(){
					plus.nativeUI.toast("服务器未响应，请稍后再试");
				}
			});
		}
		//修改密码
		$("#my-changePass").on("tap",function(){
			var messageUrl = allurlPass || "reg/changePass.html";
			var messageId = allurlPass || "reg/changePass.html";
			mui.openWindow({
				url:messageUrl,
				id:messageUrl
			})
		})
		//关于我们
		$("#my-about").on("tap",function(){
			mui.openWindow({
				url:"version.html",
				id:"version.html"
			})
		})
		//我的订单
		$("#my-dealList").on("tap",function(){
			var messageUrl = allurlPass || "shop/myDealList.html";
			var messageId = allurlPass || "shop/myDealList.html";
			mui.openWindow({
				url:messageUrl,
				id:messageUrl
			})
		})
		//我的购物车
		$("#my-cars").on("tap",function(){
			var messageUrl = allurlPass || "shop/myCar.html";
			var messageId = allurlPass || "shop/myCar.html";
			mui.openWindow({
				url:messageUrl,
				id:messageUrl
			})
		})
		//我的地址
		$("#my-address").on("tap",function(){
			var messageUrl = allurlPass || "shop/myaddress.html";
			var messageId = allurlPass || "shop/myaddress.html";
			mui.openWindow({
				url:messageUrl,
				id:messageUrl
			})
		})
	})
</script>
</html>