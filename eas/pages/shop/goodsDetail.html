<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../font/iconfont.css"/>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/shop.css"/>
		<style type="text/css">
			html,body{
				height: 100%;
			}
			.mui-bar-nav~.mui-content {
			    height: 100%;
			    overflow: scroll;
			}
			#picSlider img{
				display: block;
				width: auto;
				height: 300px;
				margin: 0 auto;
			}
		</style>
	</head>

	<body style="padding-bottom: 55px;">
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">商品详情</h1>
		</header>
		<div class="mui-content">
		    <div id="slider" class="mui-slider" >
		      <div class="mui-slider-group mui-slider-loop" id="picSlider"></div>
		      <div class="mui-slider-indicator" id="picLength"></div>
		    </div>
		    <ul class="mui-table-view" id="goods-mess">
		        <li class="mui-table-view-cell mui-media">
		            <a href="javascript:;">
		                <div class="mui-media-body">
		                   	<h3 class="goodsDet-name"></h3>
		                    <p class="mui-ellipsis goodsDet-tip"></p>
		                    <h2 class="goodsDet-nowMoy"></h2>
		                    <h5><del class="goodsDet-lastMoy"></del></h5>
		                    <h5><!--<span>运费&nbsp;&nbsp;10元</span>--><span>月销&nbsp;&nbsp;<span class="goodsDet-gSelfNum"></span></span></h5>
		                </div>
		            </a>
		        </li>
		    </ul>
		    <form class="mui-input-group" id="goods-messFont">
		        <div class="mui-input-row">
		            <label>作者</label>
		            <span class="goodsDet-author"></span>
		        </div>
		        <div class="mui-input-row">
		            <label>出版</label>
		            <span class="goodsDet-public"></span>
		        </div>
		        <div class="mui-input-row" id="toAreaRow">
		            <label>送至</label>
		            <span></span>
		        </div>
		    </form>
		</div>
		<!--<div id="goods-buyBox" class="mui-popover mui-popover-bottom mui-popover-action">
			<form class="mui-input-group">
				<div class="mui-input-row" id="goods-pic">
					<div class="goods-goodsPic"><img src="../../images/shopList.png" /></div>
					<h6><span class="goodsDet-nowMoy"></span>元</h6>
					<a href="#goods-buyBox"><span class="mui-pull-right iconfont icon-guanbi spanMargin"></span></a>
				</div>
			    <div class="mui-input-row">
			        <label>购买数量</label>
			        <div class="mui-numbox" data-numbox-min='1'>
						<button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
						<input id="buyNum" class="mui-input-numbox" type="number" value="1" />
						<button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
					</div>
			    </div>
			    <div class="mui-input-row" id="goods-area">
			    	<label>配送区域</label>
			    	<div>
			    		<h5><span class="buygoods-addr"></span><span class="mui-pull-right mui-navigate-right spanMargin"></span></h5>
			    	</div>
			    </div>
			    <div class="mui-input-row">
			    	<button type="button" id="buyBtn" class="mui-btn  mui-btn-block">确定</button>
			    </div>
			</form>
		</div>-->
		<div id="goods-buyCar" class="mui-popover mui-popover-bottom mui-popover-action">
			<form class="mui-input-group">
				<div class="mui-input-row" id="goods-carPic">
					<div class="goods-goodsPic"><img src="../../images/shopList.png" /></div>
					<h6><span class="goodsDet-nowMoy"></span>元</h6>
					<a href="#goods-buyCar"><span class="mui-pull-right iconfont icon-guanbi spanMargin"></span></a>
				</div>
			    <div class="mui-input-row">
			        <label>购买数量</label>
			        <div class="mui-numbox" data-numbox-min='1'>
						<button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
						<input id="buyCarNum" class="mui-input-numbox" type="number" value="1" />
						<button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
					</div>
			    </div>
			    <!--<div class="mui-input-row" id="goods-carArea">
			    	<label>配送区域</label>
			    	<div>
			    		<h5><span class="buygoods-addr"></span><span class="mui-pull-right mui-navigate-right spanMargin"></span></h5>
			    	</div>
			    </div>-->
			    <div class="mui-input-row">
			    	<button type="button" id="catBuyBtn" class="mui-btn  mui-btn-block">确定</button>
			    </div>
			</form>
		</div>
		<footer id="good-footer">
		    	<div>
		    		<a class="mui-tab-item" id="toBuyCar" href="#goods-buyCar">加入购物车</a>
		    	</div>
		    	<div>
		    		<a class="mui-tab-item" id="toBuyBox" href="javascript:;">立即购买</a>
		    	</div>
		</footer>
		<script type="text/javascript" src="../../js/jquery-2.1.0.js" ></script>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript">
			mui.init()
			var sellMoyNow;//现价
			mui.plusReady(function(){
				//json格式判断
				function isJSON(str) {
				        if (typeof str == 'string') {
				            try {
				                var obj=JSON.parse(str);
				                if(str.indexOf('{')>-1){
				                    return true;
				                }else{
				                    return false;
				                }
				
				            } catch(e) {
				                return false;
				            }
				        }
				        return false;
				}
				var message = localStorage.getItem("$userMess");
				var dealAddr = "";//配送地址
				if(isJSON(message)){
					var userMess = JSON.parse(message);
				}else{
					var userMess = {};
				}
				var URL = localStorage.getItem("$url");
				var AllUrl = URL.substring(1,URL.length-1);
				var self = plus.webview.currentWebview();//获取父页面传递的值
				$.ajax({
					type:"post",
					url:AllUrl+"/asw-eas/f/goodsInfo /getGoodInfo",
					async:true,
					data:{
						id:self.ids
					},
					dataType:"jsonp",
					success:function(data){
						var goodsData = data.goodInfo;
						//轮播图
						var imgSrc = data.goodInfo.gImg.split("|");
						var imgSrcLength = imgSrc.length-1;
						var newPicArr = [];
						imgSrc.forEach(function(vals,idxs){
							if(vals !== ""){
								newPicArr.push(vals);
							}
						})
						var newPicArrLeg = newPicArr.length-1;
						newPicArr.forEach(function(val,idx){
							var picList = document.createElement("div");
							$(picList).addClass("mui-slider-item");
					        $(picList).html("<a href='javascript:;'><img src='"+AllUrl+val+"'></a>");
					        $(picList).appendTo($("#picSlider"));
					        
					        if(idx == newPicArrLeg){
					        	var firstPic = document.createElement("div");
					        	$(firstPic).addClass("mui-slider-item mui-slider-item-duplicate");
					        	$(firstPic).html("<a href='javascript:;'><img src='"+AllUrl+newPicArr[0]+"'></a>");
					        	$(firstPic).appendTo($("#picSlider"));
					        };
					        var picNum = document.createElement("div");
					        if(idx == 0){
					        	$(picNum).addClass("mui-indicator mui-active");
					        	var lastPic = document.createElement("div");
					        	$(lastPic).addClass("mui-slider-item mui-slider-item-duplicate");
					        	$(lastPic).html("<a href='javascript:;'><img src='"+AllUrl+newPicArr[newPicArrLeg]+"'></a>");
					        	$(lastPic).prependTo($("#picSlider"));
					        }else{
					        	$(picNum).addClass("mui-indicator");
					        }
					        $(picNum).appendTo($("#picLength"));
						})
						mui("#slider").slider({
							interval:5000
						});
						//商品信息
						$(".goodsDet-name").text(goodsData.gName);
						$(".goodsDet-tip").text(goodsData.gProfile);
						if(goodsData.isDiscount == 0){
							sellMoyNow = goodsData.gDiscount;
							$(".goodsDet-nowMoy").text("￥"+goodsData.gDiscount);
							$(".goodsDet-lastMoy").text("原价￥"+goodsData.gPrice);
						}else{
							sellMoyNow = goodsData.gPrice;
							$(".goodsDet-nowMoy").text("￥"+goodsData.gPrice);
							$(".goodsDet-lastMoy").parent("h5").remove();
						}
						$(".goodsDet-gSelfNum").text(goodsData.gSelfNum);
						$(".goodsDet-author").text(goodsData.gAuthor);
						$(".goodsDet-public").text(goodsData.gPublish+"("+goodsData.gpubDate+")");
					}
				})
				
				window.addEventListener('refreshs', function(e){//执行刷新
				    location.reload();
				    var wobj = plus.webview.getWebviewById("pages/my.html");
					wobj.reload(true);
				});
				
				//未登录检测
				if(JSON.stringify(userMess) == "{}"){
					$("#toAreaRow").css("display","none");
					$("#toBuyCar,#toBuyBox").attr("href","");
					$("#toBuyCar,#toBuyBox").on("tap",function(){
						mui.openWindow({
							url:"../login.html",
							id:"../login.html",
							show:{
								aniShow:"slide-in-bottom"
							}
						})
					})
				}else{
					//立即购买，创建订单
					$("#toBuyBox").on("tap",function(){
						var dealDetail = ","+self.ids+','+"1/";
						$.ajax({
							type:"post",
							url:AllUrl+"/asw-eas/f/orderinfo/orderInfoApp/save",
							async:true,
							data:{
								goodsInfos:dealDetail,
								"user.id":userMess.id,
								"addressInfo.id":dealAddr
							},
							dataType:"jsonp",
							success:function(data){
								if(data.status){
									dealId = data.orderInfoId;
									mui.openWindow({
										url:"toDeal.html",
										id:"toDeal.html",
										extras:{
									       dealId:dealId
									    }
									})
								}else{
									plus.nativeUI.toast("提交订单失败，请重试")
								}
							},
							error:function(){
								plus.nativeUI.toast("提交订单失败，请重试")
							}
						});
					})
					$.ajax({
						type:"post",
						url:AllUrl+"/asw-eas/f/addressAppController/getAddressInfo",
						async:true,
						data:{
							userId:userMess.id,
							str:">"
						},
						dataType:"jsonp",
						success:function(data){
							if(data.status){
								dealAddr = data.id;
								$("#toAreaRow").find("span").text(data.name);
							}else{
								dealAddr = "";
								$("#toAreaRow").find("span").text("暂无地址信息");
							}
							
							//$(".buygoods-addr").text(data.name);
						},
						error:function(){
							plus.nativeUI.toast("服务器未响应，请稍后再试")
						}
					});
				}
				//购买数量监控
				/*$("#buyCarNum,#buyNum").on("change",function(){
					var buyNum = $(this).val();
					if(isNaN(buyNum) || buyNum<1){
						buyNum = 1;
					}else{
						buyNum = Math.floor(buyNum);
					}
					$(this).parents(".mui-popover").find(".goodsDet-nowMoy").text("￥"+sellMoyNow*buyNum)
				})*/
				//加入购物车
				$("#catBuyBtn").on("tap",function(){
					var carBuyNum = $("#buyCarNum").val();
					$.ajax({
						type:"post",
						url:AllUrl+"/asw-eas/f/ shoppingCart/save",
						async:true,
						data:{
							"uId.id":userMess.id,
							"gId.id":self.ids,
							num:carBuyNum
						},
						dataType:"jsonp",
						success:function(data){
							if(data.status == 'true'){
								plus.nativeUI.toast("已成功加入购物车");
								mui('#goods-buyCar').popover('toggle');
							}else{
								plus.nativeUI.toast("添加购物车失败，请稍后再试");
							}
						},
						error:function(){
							plus.nativeUI.toast("添加购物车失败，请稍后再试")
						}
					});
				})
			})
			/*$("#goods-area,#goods-carArea").on("tap",function(){
				mui.openWindow({
					url:"goods-wuliu.html",
					id:"goods-wuliu.html"
				})
			})*/
			
		</script>
	</body>

</html>