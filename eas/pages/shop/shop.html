<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../font/iconfont.css"/>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/shop.css"/>
		<style type="text/css">
			/*html,body{
				height: 100%;
			}*/
			/*.mui-bar-nav~.mui-content {
			    height: 100%;
			    overflow: scroll;
			}*/
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
		    <h1 class="mui-title">
		    <div class="mui-input-row mui-search">
		        <input type="search" class="mui-input-clear" placeholder="教材名称">
		    </div>
		    </h1>
		</header>
		<div id="shop-tab">
			    <ul id="shop-order">
			    	<li class="orderBydefalt actChoose">默认</li>
			    	<li class="orderBySell">销量</li>
			    	<li class="orderByMoy">价格<img src="../../images/bottom.png" /></li>
			    	<li id="shop-choose"><i class="iconfont icon-shaixuan"></i>筛选</li>
			    </ul>
			    <!--筛选弹出框-->
			    <div id="shop-chooseBox">
				    <ul id="shop-schoolLv"></ul>
				    <div id="shop-tabDetail">
				    </div>
				</div>
			</div>
		<div class="mui-content" id="pullrefresh">
		    <ul class="mui-table-view" id="shop-list"></ul>
		</div>
	</body>
	<script type="text/javascript" src="../../js/jquery-2.1.0.js" ></script>
	<script src="../../js/mui.min.js"></script>
	<script type="text/javascript">
		mui.plusReady(function(){
			//获取父页面传递的值
			var self = plus.webview.currentWebview();
			var URL = localStorage.getItem("$url");
			var AllUrl = URL.substring(1,URL.length-1);
			var chooseShow = false;
			var count = 1;//页码
			var hasMoreData = false;//是否没列表数据了
			var moyChoose = true;
			var chooseByType = [];
			if(self.types == undefined){
				self.types = "";
			}
			if(self.ids == undefined){
				self.ids = "";
			}
			var chooseIds = [self.ids];
			mui.init({
				pullRefresh: {
					container: '#pullrefresh',
					up: {
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					},
				    down: {
						style:'circle',
						auto: true,
						range:'100px',
						color:'#0099ff',
						callback: pulldownRefresh
					}
				}
			})
			
			function pullupRefresh() {
				count += 1;
				gerNextList(self.types+chooseByType.toString(),chooseIds.toString(),count);
			}
			//上拉刷新
			function pulldownRefresh(){
				gerNewList(self.types+chooseByType.toString(),chooseIds.toString(),1);
				hasMoreData = false;
				count = 1;
			}
			$("#shop-choose").on("tap",function(){
				if(!chooseShow){
					$(this).css("color","#0099ff");
					$("#shop-chooseBox").css("display","block");
					$("#shop-tab").css("height","100%");
				    document.body.classList.add("model-open");
				}else{
					$(this).css("color","#000");
					$("#shop-chooseBox").css("display","none");
					document.body.classList.remove("model-open");
	      			$("#shop-tab").css("height","auto");
				}
				chooseShow = !chooseShow;
			})
			//gerNewList(self.types,chooseIds.toString(),1);
			function gerNewList(types,gtypes,num){
				$.ajax({
					type:"post",
					url:AllUrl+"/asw-eas/f/goodsInfo/list",
					async:false,
					data:{
						pageNo:num,
						pageSize:8,
						gType:gtypes,
						type:types
					},
					dataType:"jsonp",
					success:function(data){
						var dataList = data.page.list;
						if(dataList == undefined || dataList.length == 0){
							var newLis = document.createElement("li");
							$(newLis).addClass("mui-table-view-cell mui-media");
							$(newLis).text("抱歉，暂无该类商品！");
							$(newLis).appendTo($("#shop-list"));
							hasMoreData = true;
						}else{
							$("#shop-list").html("");
							dataList.forEach(function(val,idx){
								var newLis = document.createElement("li");
								$(newLis).addClass("mui-table-view-cell mui-media").attr("id",val.id);
								var picSrc = val.gImg.split("|")[1];
								if(val.isDiscount == 0){
									var nowMoy = val.gDiscount;
									var lastMoy = "￥"+val.gPrice;
								}else{
									var nowMoy = val.gPrice;
									var lastMoy = "";
								}
								$(newLis).html("<a href='javascript:;'><img class='mui-media-object mui-pull-left' src='"+AllUrl+picSrc+"'>"+
				                "<div class='mui-media-body' style='width: 100%;'>"+
				                    "<h4>"+val.gName+"</h4>"+
				                    "<div class='shop-sellMess'><div>"+
				                    		"<p class='mui-ellipsis'>"+val.gAuthor+"编译</p>"+
				                    		"<h3><span class='shop-nowMoney'>￥"+nowMoy+"</span><del>"+lastMoy+"</del></h3>"+
				                    		"<h5>"+val.gSelfNum+"人购买过此书</h5></div><div>"+
				                    		"<span><i class='iconfont icon-gouwuche'></i></span>"+
				                    	"</div></div></div></a>");
								$(newLis).appendTo($("#shop-list"));
								$(newLis).on("tap",function(){
									//进入商品详情页
									mui.openWindow({
										url:"goodsDetail.html",
			    	            		id:"goodsDetail.html",
			    	            		extras:{
											ids:$(this).attr("id")
										}
									})
								})
							})
						}
						mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
					},
					error:function(){
						plus.nativeUI.toast("服务器暂无响应，请稍后再试!");
						mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
					}
				});
			}
			function gerNextList(types,gtypes,num){
				$.ajax({
					type:"post",
					url:AllUrl+"/asw-eas/f/goodsInfo/list",
					async:false,
					data:{
						pageNo:num,
						pageSize:8,
						gType:gtypes,
						type:types
					},
					dataType:"jsonp",
					success:function(data){
						console.log(JSON.stringify(data.page.list));
						var dataList = data.page.list;
						if(dataList == undefined ||dataList.length == 0){
							hasMoreData = true;
						}else{
							dataList.forEach(function(val,idx){
								var newLis = document.createElement("li");
								$(newLis).addClass("mui-table-view-cell mui-media").attr("id",val.id);
								var picSrc = val.gImg.split("|")[1];
								if(val.isDiscount == 0){
									var nowMoy = val.gDiscount;
									var lastMoy = "￥"+val.gPrice;
								}else{
									var nowMoy = val.gPrice;
									var lastMoy = "";
								}
								$(newLis).html("<a href='javascript:;'><img class='mui-media-object mui-pull-left' src='"+AllUrl+picSrc+"'>"+
				                "<div class='mui-media-body' style='width: 100%;'>"+
				                    "<h4>"+val.gName+"</h4>"+
				                    "<div class='shop-sellMess'><div>"+
				                    		"<p class='mui-ellipsis'>"+val.gAuthor+"编译</p>"+
				                    		"<h3><span class='shop-nowMoney'>￥"+nowMoy+"</span><del>"+lastMoy+"</del></h3>"+
				                    		"<h5>"+val.gSelfNum+"人购买过此书</h5></div><div>"+
				                    		"<span><i class='iconfont icon-gouwuche'></i></span>"+
				                    	"</div></div></div></a>");
								$(newLis).appendTo($("#shop-list"));
								$(newLis).on("tap",function(){
									//进入商品详情页
									mui.openWindow({
										url:"goodsDetail.html",
			    	            		id:"goodsDetail.html",
			    	            		extras:{
											ids:$(this).attr("id")
										}
									})
								})
							})
						}
						mui('#pullrefresh').pullRefresh().endPullupToRefresh(hasMoreData);
					},
					error:function(){
						plus.nativeUI.toast("服务器暂无响应，请稍后再试!");
					}
				});
			}
			//获取筛选信息
			$.ajax({
				type:"post",
				url:AllUrl+"/asw-eas/f/sysAppmdict/sysMdict/list",
				async:true,
				data:{
					"parent.id":"1c5337a0e843430196ffa3474232a591"
				},
				dataType:"jsonp",
				success:function(data){
					data.forEach(function(val,idx){
						var newSchoolLv = document.createElement("li");
						if(idx == 0){
							$(newSchoolLv).addClass("tabListAct");
						}
						$(newSchoolLv).attr("id",val.id);
						$(newSchoolLv).text(val.name);
						$(newSchoolLv).appendTo($("#shop-schoolLv"));
						$.ajax({
							type:"post",
							url:AllUrl+"/asw-eas/f/sysAppmdict/sysMdict/list",
							async:true,
							data:{
								"parent.id":val.id
							},
							dataType:"jsonp",
							success:function(data){
								var chooseDet = document.createElement("ul");
								$(chooseDet).attr("parentId",data[0].parentId);
								data.forEach(function(vals,idxs){
									var chooseDetLi = document.createElement("li");
									$(chooseDetLi).text(vals.name).attr({"id":vals.id,"pId":vals.parentId});
									$(chooseDetLi).appendTo($(chooseDet));
								})
								$(chooseDet).appendTo($("#shop-tabDetail"));
							}
						});
					})
				},
				error:function(){
					
				}
			});
			$("#shop-schoolLv").on("tap","li",function(){
				if($(this).hasClass("tabListAct")){
					return;
				}else{
					var tabIdx = $(this).attr("id");
					var tabUl = $("#shop-tabDetail")[0].children;
					$(this).addClass("tabListAct").siblings().removeClass("tabListAct");
					for(var i=0;i<tabUl.length;i++){
						if($(tabUl[i]).attr("parentId") == tabIdx){
							$(tabUl[i]).css({"display":"block"});
						}else{
							$(tabUl[i]).css({"display":"none"});
						}
					}
				}
			})
			//筛选条件查询
			$("#shop-tabDetail").on("tap","li",function(){
				$("#shop-tabDetail").find("li").removeClass("actDetailChoose");
				$(this).addClass("actDetailChoose");
				chooseIds = [self.ids];
				var newChooseIds = $(this).attr("id");
				chooseIds.unshift(newChooseIds);
				gerNewList(chooseByType.toString(),chooseIds.toString());
				$("#shop-choose").css("color","#000");
				$("#shop-chooseBox").css("display","none");
				document.body.classList.remove("model-open");
      			$("#shop-tab").css("height","auto");	
      			chooseShow = !chooseShow;
			})
			$("#shop-order").on("tap","li",function(){
				//默认排序判断
				if($(this).hasClass("orderBydefalt")){
					if($(this).hasClass("actChoose")){
						return;
					}else{
						chooseByType = [];
						gerNewList("",chooseIds.toString());
						$(this).siblings().removeClass("actChoose");
						$(this).addClass("actChoose");
					}
				}
				//销量排序
				if($(this).hasClass("orderBySell")){
					if($(this).hasClass("actChoose")){
						return;
					}else{
						chooseByType.push("AelfNumDesc");
						gerNewList(chooseByType.toString(),chooseIds.toString());
						$(".orderBydefalt").removeClass("actChoose");
						$(this).addClass("actChoose");
					}
				}
				//价格排序
				if($(this).hasClass("orderByMoy")){
					if($(this).hasClass("actChoose")){
						if(!moyChoose){
							//价格由低到高
							if(chooseByType.indexOf("gprice")<0){
								chooseByType.push("gprice")
							}
							if(chooseByType.indexOf("ApriceDesc") !== -1){
								var index = chooseByType.indexOf("ApriceDesc");
								chooseByType.splice(index,1)
							}
							gerNewList(chooseByType.toString(),chooseIds.toString());
							$(this).find("img").css("transform","rotate(180deg)");
							moyChoose = !moyChoose;
						}else{
							//价格由高到低
							if(chooseByType.indexOf("ApriceDesc ")<0){
								chooseByType.push("ApriceDesc ")
							}
							if(chooseByType.indexOf("gprice") !== -1){
								var index = chooseByType.indexOf("gprice");
								chooseByType.splice(index,1)
							}
							gerNewList(chooseByType.toString(),chooseIds.toString());
							$(this).find("img").css("transform","rotate(0deg)");
							moyChoose = !moyChoose;
						}
					}else{
						$(".orderBydefalt").removeClass("actChoose");
						$(this).find("img").css("transform","rotate(0deg)");
						$(this).addClass("actChoose");
						//价格由高到低
						if(chooseByType.indexOf("ApriceDesc")<0){
							chooseByType.push("ApriceDesc")
						}
						if(chooseByType.indexOf("gprice") !== -1){
							var index = chooseByType.indexOf("gprice");
							chooseByType.splice(index,1)
						}
						gerNewList(chooseByType.toString(),chooseIds.toString());
						moyChoose = !moyChoose;
					}
				}
			})
		})
	</script>
</html>